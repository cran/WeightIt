<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Noah Greifer" />

<meta name="date" content="2023-05-09" />

<title>Using WeightIt to Estimate Balancing Weights</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">

div.csl-bib-body { }
div.csl-entry {
clear: both;
}
.hanging div.csl-entry {
margin-left:2em;
text-indent:-2em;
}
div.csl-left-margin {
min-width:2em;
float:left;
}
div.csl-right-inline {
margin-left:2em;
padding-left:1em;
}
div.csl-indent {
margin-left: 2em;
}
</style>

<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Using WeightIt to Estimate Balancing
Weights</h1>
<h4 class="author">Noah Greifer</h4>
<h4 class="date">2023-05-09</h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p><code>WeightIt</code> contains several functions for estimating and
assessing balancing weights for observational studies. These weights can
be used to estimate the causal parameters of marginal structural models.
I will not go into the basics of causal inference methods here. For good
introductory articles, see <span class="citation">Austin (<a href="#ref-austinIntroductionPropensityScore2011" role="doc-biblioref">2011</a>)</span>, <span class="citation">Austin and
Stuart (<a href="#ref-austinMovingBestPractice2015" role="doc-biblioref">2015</a>)</span>, <span class="citation">Robins,
Hernán, and Brumback (<a href="#ref-robinsMarginalStructuralModels2000" role="doc-biblioref">2000</a>)</span>, or <span class="citation">Thoemmes and Ong (<a href="#ref-thoemmesPrimerInverseProbability2016" role="doc-biblioref">2016</a>)</span>.</p>
<p>Typically, the analysis of an observation study might proceed as
follows: identify the covariates for which balance is required; assess
the quality of the data available, including missingness and measurement
error; estimate weights that balance the covariates adequately; and
estimate a treatment effect and corresponding standard error or
confidence interval. This guide will go through all these steps for two
observational studies: estimating the causal effect of a point treatment
on an outcome, and estimating the causal parameters of a marginal
structural model with multiple treatment periods. This is not meant to
be a definitive guide, but rather an introduction to the relevant
issues.</p>
</div>
<div id="balancing-weights-for-a-point-treatment" class="section level2">
<h2>Balancing Weights for a Point Treatment</h2>
<p>First we will use the Lalonde dataset to estimate the effect of a
point treatment. We’ll use the version of the data set that resides
within the <code>cobalt</code> package, which we will use later on as
well. Here, we are interested in the average treatment effect on the
treated (ATT).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;cobalt&quot;</span>)</span></code></pre></div>
<pre><code>##  cobalt (Version 4.5.1, Build Date: 2023-04-27)</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;lalonde&quot;</span>, <span class="at">package =</span> <span class="st">&quot;cobalt&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(lalonde)</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">treat</th>
<th align="right">age</th>
<th align="right">educ</th>
<th align="left">race</th>
<th align="right">married</th>
<th align="right">nodegree</th>
<th align="right">re74</th>
<th align="right">re75</th>
<th align="right">re78</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">37</td>
<td align="right">11</td>
<td align="left">black</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">9930.0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">22</td>
<td align="right">9</td>
<td align="left">hispan</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">3595.9</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">30</td>
<td align="right">12</td>
<td align="left">black</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">24909.5</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">27</td>
<td align="right">11</td>
<td align="left">black</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">7506.1</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">33</td>
<td align="right">8</td>
<td align="left">black</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">289.8</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">22</td>
<td align="right">9</td>
<td align="left">black</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">4056.5</td>
</tr>
</tbody>
</table>
</div>
<p>We have our outcome (<code>re78</code>), our treatment
(<code>treat</code>), and the covariates for which balance is desired
(<code>age</code>, <code>educ</code>, <code>race</code>,
<code>married</code>, <code>nodegree</code>, <code>re74</code>, and
<code>re75</code>). Using <code>cobalt</code>, we can examine the
initial imbalance on the covariates:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> lalonde, <span class="at">estimand =</span> <span class="st">&quot;ATT&quot;</span>, <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">05</span>))</span></code></pre></div>
<pre><code>## Balance Measures
##                Type Diff.Un      M.Threshold.Un
## age         Contin.  -0.309 Not Balanced, &gt;0.05
## educ        Contin.   0.055 Not Balanced, &gt;0.05
## race_black   Binary   0.640 Not Balanced, &gt;0.05
## race_hispan  Binary  -0.083 Not Balanced, &gt;0.05
## race_white   Binary  -0.558 Not Balanced, &gt;0.05
## married      Binary  -0.324 Not Balanced, &gt;0.05
## nodegree     Binary   0.111 Not Balanced, &gt;0.05
## re74        Contin.  -0.721 Not Balanced, &gt;0.05
## re75        Contin.  -0.290 Not Balanced, &gt;0.05
## 
## Balance tally for mean differences
##                     count
## Balanced, &lt;0.05         0
## Not Balanced, &gt;0.05     9
## 
## Variable with the greatest mean difference
##  Variable Diff.Un      M.Threshold.Un
##      re74  -0.721 Not Balanced, &gt;0.05
## 
## Sample sizes
##     Control Treated
## All     429     185</code></pre>
<p>Based on this output, we can see that all variables are imbalanced in
the sense that the standardized mean differences (for continuous
variables) and differences in proportion (for binary variables) are
greater than .05 for all variables. In particular, <code>re74</code> and
<code>re75</code> are quite imbalanced, which is troubling given that
they are likely strong predictors of the outcome. We will estimate
weights using <code>weightit()</code> to try to attain balance on these
covariates.</p>
<p>First, we’ll start simple, and use inverse probability weights from
propensity scores generated through logistic regression. We need to
supply <code>weightit()</code> with the formula for the model, the data
set, the estimand (ATT), and the method of estimation
(<code>&quot;glm&quot;</code>) for generalized linear model propensity score
weights).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;WeightIt&quot;</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>W.out <span class="ot">&lt;-</span> <span class="fu">weightit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> lalonde, <span class="at">estimand =</span> <span class="st">&quot;ATT&quot;</span>, <span class="at">method =</span> <span class="st">&quot;glm&quot;</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>W.out <span class="co">#print the output</span></span></code></pre></div>
<pre><code>## A weightit object
##  - method: &quot;glm&quot; (propensity score weighting with GLM)
##  - number of obs.: 614
##  - sampling weights: none
##  - treatment: 2-category
##  - estimand: ATT (focal: 1)
##  - covariates: age, educ, race, married, nodegree, re74, re75</code></pre>
<p>Printing the output of <code>weightit()</code> displays a summary of
how the weights were estimated. Let’s examine the quality of the weights
using <code>summary()</code>. Weights with low variability are desirable
because they improve the precision of the estimator. This variability is
presented in several ways: by the ratio of the largest weight to the
smallest in each group, the coefficient of variation (standard deviation
divided by the mean) of the weights in each group, and the effective
sample size computed from the weights. We want a small ratio, a smaller
coefficient of variation, and a large effective sample size (ESS). What
constitutes these values is mostly relative, though, and must be
balanced with other constraints, including covariate balance. These
metrics are best used when comparing weighting methods, but the ESS can
give a sense of how much information remains in the weighted sample on a
familiar scale.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(W.out)</span></code></pre></div>
<pre><code>##                  Summary of weights
## 
## - Weight ranges:
## 
##            Min                                 Max
## treated 1.0000         ||                    1.000
## control 0.0092 |---------------------------| 3.743
## 
## - Units with the 5 most extreme weights by group:
##                                            
##               5      4      3      2      1
##  treated      1      1      1      1      1
##             597    573    381    411    303
##  control 3.0301 3.0592 3.2397 3.5231 3.7432
## 
## - Weight statistics:
## 
##         Coef of Var   MAD Entropy # Zeros
## treated       0.000 0.000  -0.000       0
## control       1.818 1.289   1.098       0
## 
## - Effective Sample Sizes:
## 
##            Control Treated
## Unweighted  429.       185
## Weighted     99.82     185</code></pre>
<p>These weights have quite high variability, and yield an ESS of close
to 100 in the control group. Let’s see if these weights managed to yield
balance on our covariates.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(W.out, <span class="at">stats =</span> <span class="fu">c</span>(<span class="st">&quot;m&quot;</span>, <span class="st">&quot;v&quot;</span>), <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">05</span>))</span></code></pre></div>
<pre><code>## Balance Measures
##                 Type Diff.Adj         M.Threshold V.Ratio.Adj
## prop.score  Distance   -0.021     Balanced, &lt;0.05       1.032
## age          Contin.    0.119 Not Balanced, &gt;0.05       0.458
## educ         Contin.   -0.028     Balanced, &lt;0.05       0.664
## race_black    Binary   -0.002     Balanced, &lt;0.05           .
## race_hispan   Binary    0.000     Balanced, &lt;0.05           .
## race_white    Binary    0.002     Balanced, &lt;0.05           .
## married       Binary    0.019     Balanced, &lt;0.05           .
## nodegree      Binary    0.018     Balanced, &lt;0.05           .
## re74         Contin.   -0.002     Balanced, &lt;0.05       1.321
## re75         Contin.    0.011     Balanced, &lt;0.05       1.394
## 
## Balance tally for mean differences
##                     count
## Balanced, &lt;0.05         9
## Not Balanced, &gt;0.05     1
## 
## Variable with the greatest mean difference
##  Variable Diff.Adj         M.Threshold
##       age    0.119 Not Balanced, &gt;0.05
## 
## Effective sample sizes
##            Control Treated
## Unadjusted  429.       185
## Adjusted     99.82     185</code></pre>
<p>For nearly all the covariates, these weights yielded very good
balance. Only <code>age</code> remained imbalanced, with a standardized
mean difference greater than .05 and a variance ratio greater than 2.
Let’s see if we can do better. We’ll choose a different method: entropy
balancing <span class="citation">(<a href="#ref-hainmuellerEntropyBalancingCausal2012" role="doc-biblioref">Hainmueller 2012</a>)</span>, which guarantees
perfect balance on specified moments of the covariates while minimizing
the entropy (a measure of dispersion) of the weights.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>W.out <span class="ot">&lt;-</span> <span class="fu">weightit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> lalonde, <span class="at">estimand =</span> <span class="st">&quot;ATT&quot;</span>, <span class="at">method =</span> <span class="st">&quot;ebal&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(W.out)</span></code></pre></div>
<pre><code>##                  Summary of weights
## 
## - Weight ranges:
## 
##            Min                                 Max
## treated 1.0000    ||                         1.000
## control 0.0188 |---------------------------| 9.419
## 
## - Units with the 5 most extreme weights by group:
##                                            
##               5      4      3      2      1
##  treated      1      1      1      1      1
##             608    381    597    303    411
##  control 7.1268 7.5013 7.9979 9.0355 9.4195
## 
## - Weight statistics:
## 
##         Coef of Var   MAD Entropy # Zeros
## treated       0.000 0.000   0.000       0
## control       1.834 1.287   1.101       0
## 
## - Effective Sample Sizes:
## 
##            Control Treated
## Unweighted  429.       185
## Weighted     98.46     185</code></pre>
<p>The variability of the weights has not changed much, but let’s see if
there are any gains in terms of balance:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(W.out, <span class="at">stats =</span> <span class="fu">c</span>(<span class="st">&quot;m&quot;</span>, <span class="st">&quot;v&quot;</span>), <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">05</span>))</span></code></pre></div>
<pre><code>## Balance Measures
##                Type Diff.Adj     M.Threshold V.Ratio.Adj
## age         Contin.        0 Balanced, &lt;0.05       0.410
## educ        Contin.        0 Balanced, &lt;0.05       0.664
## race_black   Binary        0 Balanced, &lt;0.05           .
## race_hispan  Binary       -0 Balanced, &lt;0.05           .
## race_white   Binary       -0 Balanced, &lt;0.05           .
## married      Binary       -0 Balanced, &lt;0.05           .
## nodegree     Binary       -0 Balanced, &lt;0.05           .
## re74        Contin.       -0 Balanced, &lt;0.05       1.326
## re75        Contin.       -0 Balanced, &lt;0.05       1.335
## 
## Balance tally for mean differences
##                     count
## Balanced, &lt;0.05         9
## Not Balanced, &gt;0.05     0
## 
## Variable with the greatest mean difference
##  Variable Diff.Adj     M.Threshold
##   married       -0 Balanced, &lt;0.05
## 
## Effective sample sizes
##            Control Treated
## Unadjusted  429.       185
## Adjusted     98.46     185</code></pre>
<p>Indeed, we have achieved perfect balance on the means of the
covariates. However, the variance ratio of <code>age</code> is still
quite high. We could continue to try to adjust for this imbalance, but
if there is reason to believe it is unlikely to affect the outcome, it
may be best to leave it as is. (You can try adding <code>I(age^2)</code>
to the formula and see what changes this causes.)</p>
<p>Now that we have our weights stored in <code>W.out</code>, let’s
extract them and estimate our treatment effect.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Attach weights to dataset</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>weights <span class="ot">&lt;-</span> W.out<span class="sc">$</span>weights</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit outcome model</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat <span class="sc">*</span> (age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                            nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> lalonde, <span class="at">weights =</span> weights)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># G-computation for the treatment effect</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;marginaleffects&quot;</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="fu">avg_comparisons</span>(fit, <span class="at">variables =</span> <span class="st">&quot;treat&quot;</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">vcov =</span> <span class="st">&quot;HC3&quot;</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> <span class="fu">subset</span>(lalonde, treat <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">wts =</span> <span class="st">&quot;weights&quot;</span>)</span></code></pre></div>
<div class="kable-table">
<table>
<colgroup>
<col width="8%" />
<col width="12%" />
<col width="12%" />
<col width="14%" />
<col width="14%" />
<col width="11%" />
<col width="12%" />
<col width="14%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="left">contrast</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">statistic</th>
<th align="right">p.value</th>
<th align="right">conf.low</th>
<th align="right">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">treat</td>
<td align="left">1 - 0</td>
<td align="right">1273</td>
<td align="right">822.8</td>
<td align="right">1.547</td>
<td align="right">0.1218</td>
<td align="right">-339.4</td>
<td align="right">2886</td>
</tr>
</tbody>
</table>
</div>
<p>Our confidence interval for <code>treat</code> contains 0, so there
isn’t evidence that <code>treat</code> has an effect on
<code>re78</code>. Although some authors recommend using “robust”
sandwich standard errors to adjust for the weights <span class="citation">(<a href="#ref-robinsMarginalStructuralModels2000" role="doc-biblioref">Robins, Hernán, and Brumback 2000</a>; <a href="#ref-hainmuellerEntropyBalancingCausal2012" role="doc-biblioref">Hainmueller 2012</a>)</span> as we did above,
others believe these can misleading and recommend bootstrapping instead
<span class="citation">(<a href="#ref-reifeisVarianceTreatmentEffect2020" role="doc-biblioref">Reifeis and Hudgens 2020</a>; <a href="#ref-chanGloballyEfficientNonparametric2016" role="doc-biblioref">Chan, Yam, and Zhang 2016</a>)</span>. Both methods
are described in detail at
<code>vignette(&quot;estimating-effects&quot;)</code>.</p>
</div>
<div id="balancing-weights-for-a-longitudinal-treatment" class="section level2">
<h2>Balancing Weights for a Longitudinal Treatment</h2>
<p><code>WeightIt</code> can estimate weights for longitudinal treatment
marginal structural models as well. This time, we’ll use the sample data
set <code>msmdata</code> to estimate our weights. Data must be in “wide”
format, with one row per unit.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;msmdata&quot;</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(msmdata)</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">X1_0</th>
<th align="right">X2_0</th>
<th align="right">A_1</th>
<th align="right">X1_1</th>
<th align="right">X2_1</th>
<th align="right">A_2</th>
<th align="right">X1_2</th>
<th align="right">X2_2</th>
<th align="right">A_3</th>
<th align="right">Y_B</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">5</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">9</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">10</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">5</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">6</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">6</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">5</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">6</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
<p>We have a binary outcome variable (<code>Y_B</code>), pre-treatment
time-varying variables (<code>X1_0</code> and <code>X2_0</code>,
measured before the first treatment, <code>X1_1</code> and
<code>X2_1</code> measured between the first and second treatments, and
<code>X1_2</code> and <code>X2_2</code> measured between the second and
third treatments), and three time-varying binary treatment variables
(<code>A_1</code>, <code>A_2</code>, and <code>A_3</code>). We are
interested in the joint, unique, causal effects of each treatment period
on the outcome. At each treatment time point, we need to achieve balance
on all variables measured prior to that treatment, including previous
treatments.</p>
<p>Using <code>cobalt</code>, we can examine the initial imbalance at
each time point and overall:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;cobalt&quot;</span>) <span class="co">#if not already attached</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(<span class="fu">list</span>(A_1 <span class="sc">~</span> X1_0 <span class="sc">+</span> X2_0,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>             A_2 <span class="sc">~</span> X1_1 <span class="sc">+</span> X2_1 <span class="sc">+</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>               A_1 <span class="sc">+</span> X1_0 <span class="sc">+</span> X2_0,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>             A_3 <span class="sc">~</span> X1_2 <span class="sc">+</span> X2_2 <span class="sc">+</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>               A_2 <span class="sc">+</span> X1_1 <span class="sc">+</span> X2_1 <span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>               A_1 <span class="sc">+</span> X1_0 <span class="sc">+</span> X2_0),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> msmdata, <span class="at">stats =</span> <span class="fu">c</span>(<span class="st">&quot;m&quot;</span>, <span class="st">&quot;ks&quot;</span>),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">which.time =</span> .all)</span></code></pre></div>
<pre><code>## Balance by Time Point
## 
##  - - - Time: 1 - - - 
## Balance Measures
##         Type Diff.Un KS.Un
## X1_0 Contin.   0.690 0.276
## X2_0  Binary  -0.325 0.325
## 
## Sample sizes
##     Control Treated
## All    3306    4194
## 
##  - - - Time: 2 - - - 
## Balance Measures
##         Type Diff.Un KS.Un
## X1_1 Contin.   0.874 0.340
## X2_1  Binary  -0.299 0.299
## A_1   Binary   0.127 0.127
## X1_0 Contin.   0.528 0.201
## X2_0  Binary  -0.060 0.060
## 
## Sample sizes
##     Control Treated
## All    3701    3799
## 
##  - - - Time: 3 - - - 
## Balance Measures
##         Type Diff.Un KS.Un
## X1_2 Contin.   0.475 0.212
## X2_2  Binary  -0.594 0.594
## A_2   Binary   0.162 0.162
## X1_1 Contin.   0.573 0.237
## X2_1  Binary  -0.040 0.040
## A_1   Binary   0.100 0.100
## X1_0 Contin.   0.361 0.148
## X2_0  Binary  -0.040 0.040
## 
## Sample sizes
##     Control Treated
## All    4886    2614
##  - - - - - - - - - - -</code></pre>
<p><code>bal.tab()</code> indicates significant imbalance on most
covariates at most time points, so we need to do some work to eliminate
that imbalance in our weighted data set. We’ll use the
<code>weightitMSM()</code> function to specify our weight models. The
syntax is similar both to that of <code>weightit()</code> for point
treatments and to that of <code>bal.tab()</code> for longitudinal
treatments. We’ll use <code>method = &quot;glm&quot;</code> and
<code>stabilize = TRUE</code> for stabilized propensity score weights
estimated using logistic regression.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>Wmsm.out <span class="ot">&lt;-</span> <span class="fu">weightitMSM</span>(<span class="fu">list</span>(A_1 <span class="sc">~</span> X1_0 <span class="sc">+</span> X2_0,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                             A_2 <span class="sc">~</span> X1_1 <span class="sc">+</span> X2_1 <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                               A_1 <span class="sc">+</span> X1_0 <span class="sc">+</span> X2_0,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                             A_3 <span class="sc">~</span> X1_2 <span class="sc">+</span> X2_2 <span class="sc">+</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                               A_2 <span class="sc">+</span> X1_1 <span class="sc">+</span> X2_1 <span class="sc">+</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                               A_1 <span class="sc">+</span> X1_0 <span class="sc">+</span> X2_0),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> msmdata, <span class="at">method =</span> <span class="st">&quot;glm&quot;</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">stabilize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>Wmsm.out</span></code></pre></div>
<pre><code>## A weightitMSM object
##  - method: &quot;glm&quot; (propensity score weighting with GLM)
##  - number of obs.: 7500
##  - sampling weights: none
##  - number of time points: 3 (A_1, A_2, A_3)
##  - treatment: 
##     + time 1: 2-category
##     + time 2: 2-category
##     + time 3: 2-category
##  - covariates: 
##     + baseline: X1_0, X2_0
##     + after time 1: X1_1, X2_1, A_1, X1_0, X2_0
##     + after time 2: X1_2, X2_2, A_2, X1_1, X2_1, A_1, X1_0, X2_0
##  - stabilized; stabilization factors:
##     + baseline: (none)
##     + after time 1: A_1
##     + after time 2: A_1, A_2, A_1:A_2</code></pre>
<p>No matter which method is selected, <code>weightitMSM()</code>
estimates separate weights for each time period and then takes the
product of the weights for each individual to arrive at the final
estimated weights. Printing the output of <code>weightitMSM()</code>
provides some details about the function call and the output. We can
take a look at the quality of the weights with <code>summary()</code>,
just as we could for point treatments.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(Wmsm.out)</span></code></pre></div>
<pre><code>##                  Summary of weights
## 
##                        Time 1                       
##                  Summary of weights
## 
## - Weight ranges:
## 
##            Min                                 Max
## treated 0.1527 |---------------------------| 57.08
## control 0.1089 |--------|                    20.46
## 
## - Units with the 5 most extreme weights by group:
##                                                
##             4390    3440    3774   3593    5685
##  treated 22.1008 24.1278 25.6999 27.786 57.0794
##             6659    6284    1875   6163    2533
##  control 12.8943   13.09 14.5234 14.705  20.465
## 
## - Weight statistics:
## 
##         Coef of Var   MAD Entropy # Zeros
## treated       1.779 0.775   0.573       0
## control       1.331 0.752   0.486       0
## 
## - Mean of Weights = 0.99
## 
## - Effective Sample Sizes:
## 
##            Control Treated
## Unweighted    3306    4194
## Weighted      1193    1007
## 
##                        Time 2                       
##                  Summary of weights
## 
## - Weight ranges:
## 
##            Min                                 Max
## treated 0.1089 |---------------------------| 57.08
## control 0.1501 |--------|                    20.49
## 
## - Units with the 5 most extreme weights by group:
##                                                 
##             4390    3440    3774    3593    5685
##  treated 22.1008 24.1278 25.6999  27.786 57.0794
##             1875    6163    6862    1286    6158
##  control 14.5234  14.705 14.8079 16.2311 20.4862
## 
## - Weight statistics:
## 
##         Coef of Var   MAD Entropy # Zeros
## treated       1.797 0.779   0.580       0
## control       1.359 0.750   0.488       0
## 
## - Mean of Weights = 0.99
## 
## - Effective Sample Sizes:
## 
##            Control Treated
## Unweighted    3701  3799. 
## Weighted      1300   898.2
## 
##                        Time 3                       
##                  Summary of weights
## 
## - Weight ranges:
## 
##            Min                                 Max
## treated 0.1089 |---------------------------| 57.08
## control 0.2085 |-----------|                 25.70
## 
## - Units with the 5 most extreme weights by group:
##                                                 
##             3576    4390    3440    3593    5685
##  treated 20.5828 22.1008 24.1278  27.786 57.0794
##             6163    6862     168    6158    3774
##  control  14.705 14.8079 16.9698 20.4862 25.6999
## 
## - Weight statistics:
## 
##         Coef of Var   MAD Entropy # Zeros
## treated       2.008 0.931   0.753       0
## control       1.269 0.672   0.407       0
## 
## - Mean of Weights = 0.99
## 
## - Effective Sample Sizes:
## 
##            Control Treated
## Unweighted    4886  2614. 
## Weighted      1871   519.8</code></pre>
<p>Displayed are summaries of how the weights perform at each time point
with respect to variability. Next, we’ll examine how well they perform
with respect to covariate balance.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(Wmsm.out, <span class="at">stats =</span> <span class="fu">c</span>(<span class="st">&quot;m&quot;</span>, <span class="st">&quot;ks&quot;</span>), <span class="at">which.time =</span> .none)</span></code></pre></div>
<pre><code>## Balance summary across all time points
##              Times     Type Max.Diff.Adj Max.KS.Adj
## prop.score 1, 2, 3 Distance        0.095      0.074
## X1_0       1, 2, 3  Contin.        0.033      0.018
## X2_0       1, 2, 3   Binary        0.018      0.018
## X1_1          2, 3  Contin.        0.087      0.039
## X2_1          2, 3   Binary        0.031      0.031
## A_1           2, 3   Binary        0.130      0.130
## X1_2             3  Contin.        0.104      0.054
## X2_2             3   Binary        0.007      0.007
## A_2              3   Binary        0.154      0.154
## 
## Effective sample sizes
##  - Time 1
##            Control Treated
## Unadjusted    3306    4194
## Adjusted      1193    1007
##  - Time 2
##            Control Treated
## Unadjusted    3701  3799. 
## Adjusted      1300   898.2
##  - Time 3
##            Control Treated
## Unadjusted    4886  2614. 
## Adjusted      1871   519.8</code></pre>
<p>By setting <code>which.time = .none</code> in <code>bal.tab()</code>,
we can focus on the overall balance assessment, which displays the
greatest imbalance for each covariate across time points. We can see
that our estimated weights balance all covariates all time points with
respect to means and KS statistics. Now we can estimate our treatment
effects.</p>
<p>First, we fit a marginal structural model for the outcome using
<code>glm()</code> with the weights included:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Attach weights to dataset</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>msmdata<span class="sc">$</span>weights <span class="ot">&lt;-</span> Wmsm.out<span class="sc">$</span>weights</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit outcome model</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_B <span class="sc">~</span> A_1 <span class="sc">*</span> A_2 <span class="sc">*</span> A_3 <span class="sc">*</span> (X1_0 <span class="sc">+</span> X2_0),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> msmdata, <span class="at">weights =</span> weights,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">family =</span> quasibinomial)</span></code></pre></div>
<p>Then, we compute the average expected potential outcomes under each
treatment regime using
<code>marginaleffects::avg_predictions()</code>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;marginaleffects&quot;</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>(p <span class="ot">&lt;-</span> <span class="fu">avg_predictions</span>(fit,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">vcov =</span> <span class="st">&quot;HC3&quot;</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">newdata =</span> <span class="fu">datagridcf</span>(<span class="at">A_1 =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">A_2 =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">A_3 =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;A_1&quot;</span>, <span class="st">&quot;A_2&quot;</span>, <span class="st">&quot;A_3&quot;</span>),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">wts =</span> <span class="st">&quot;weights&quot;</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span></code></pre></div>
<div class="kable-table">
<table>
<colgroup>
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="13%" />
<col width="14%" />
<col width="14%" />
<col width="11%" />
<col width="13%" />
<col width="14%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">A_1</th>
<th align="right">A_2</th>
<th align="right">A_3</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">statistic</th>
<th align="right">p.value</th>
<th align="right">conf.low</th>
<th align="right">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.6847</td>
<td align="right">0.0169</td>
<td align="right">40.57</td>
<td align="right">0</td>
<td align="right">0.6516</td>
<td align="right">0.7178</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.5177</td>
<td align="right">0.0398</td>
<td align="right">13.00</td>
<td align="right">0</td>
<td align="right">0.4396</td>
<td align="right">0.5957</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0.4884</td>
<td align="right">0.0217</td>
<td align="right">22.51</td>
<td align="right">0</td>
<td align="right">0.4459</td>
<td align="right">0.5309</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0.4340</td>
<td align="right">0.0309</td>
<td align="right">14.06</td>
<td align="right">0</td>
<td align="right">0.3735</td>
<td align="right">0.4945</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.6005</td>
<td align="right">0.0218</td>
<td align="right">27.61</td>
<td align="right">0</td>
<td align="right">0.5579</td>
<td align="right">0.6431</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.5407</td>
<td align="right">0.0334</td>
<td align="right">16.21</td>
<td align="right">0</td>
<td align="right">0.4753</td>
<td align="right">0.6061</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0.3754</td>
<td align="right">0.0170</td>
<td align="right">22.02</td>
<td align="right">0</td>
<td align="right">0.3419</td>
<td align="right">0.4088</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0.4189</td>
<td align="right">0.0285</td>
<td align="right">14.70</td>
<td align="right">0</td>
<td align="right">0.3630</td>
<td align="right">0.4747</td>
</tr>
</tbody>
</table>
</div>
<p>We can compare the expected potential outcomes under each regime
using <code>marginaleffects::hypotheses()</code>. To get all pairwise
comparisons, supply the <code>avg_predictions()</code> output to
<code>hypotheses(., &quot;pairwise&quot;)</code>. To compare individual regimes,
we can use <code>hypotheses()</code>, identifying the rows of the
<code>avg_predictions()</code> output. For example, to compare the
regimes with no treatment for all three time points vs. the regime with
treatment for all three time points, we would run</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hypotheses</span>(p, <span class="st">&quot;b8 - b1 = 0&quot;</span>)</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">statistic</th>
<th align="right">p.value</th>
<th align="right">conf.low</th>
<th align="right">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">b8-b1=0</td>
<td align="right">-0.2658</td>
<td align="right">0.0182</td>
<td align="right">-14.63</td>
<td align="right">0</td>
<td align="right">-0.3014</td>
<td align="right">-0.2302</td>
</tr>
</tbody>
</table>
</div>
<p>These results indicate that receive treatment at all time points
reduces the risk of the outcome relative to not receiving treatment at
all.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="unnumbered">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-austinIntroductionPropensityScore2011" class="csl-entry">
Austin, Peter C. 2011. <span>“An Introduction to Propensity Score
Methods for Reducing the Effects of Confounding in Observational
Studies.”</span> <em>Multivariate Behavioral Research</em> 46 (3):
399–424. <a href="https://doi.org/10.1080/00273171.2011.568786">https://doi.org/10.1080/00273171.2011.568786</a>.
</div>
<div id="ref-austinMovingBestPractice2015" class="csl-entry">
Austin, Peter C., and Elizabeth A. Stuart. 2015. <span>“Moving Towards
Best Practice When Using Inverse Probability of Treatment Weighting
(<span>IPTW</span>) Using the Propensity Score to Estimate Causal
Treatment Effects in Observational Studies.”</span> <em>Statistics in
Medicine</em> 34 (28): 3661–79. <a href="https://doi.org/10.1002/sim.6607">https://doi.org/10.1002/sim.6607</a>.
</div>
<div id="ref-chanGloballyEfficientNonparametric2016" class="csl-entry">
Chan, Kwun Chuen Gary, Sheung Chi Phillip Yam, and Zheng Zhang. 2016.
<span>“Globally Efficient Non-Parametric Inference of Average Treatment
Effects by Empirical Balancing Calibration Weighting.”</span>
<em>Journal of the Royal Statistical Society: Series B (Statistical
Methodology)</em> 78 (3): 673–700. <a href="https://doi.org/10.1111/rssb.12129">https://doi.org/10.1111/rssb.12129</a>.
</div>
<div id="ref-hainmuellerEntropyBalancingCausal2012" class="csl-entry">
Hainmueller, J. 2012. <span>“Entropy Balancing for Causal Effects:
<span>A</span> Multivariate Reweighting Method to Produce Balanced
Samples in Observational Studies.”</span> <em>Political Analysis</em> 20
(1): 25–46. <a href="https://doi.org/10.1093/pan/mpr025">https://doi.org/10.1093/pan/mpr025</a>.
</div>
<div id="ref-reifeisVarianceTreatmentEffect2020" class="csl-entry">
Reifeis, Sarah A., and Michael G. Hudgens. 2020. <span>“On Variance of
the Treatment Effect in the Treated Using Inverse Probability
Weighting.”</span> <em>arXiv:2011.11874 [Stat]</em>, November. <a href="https://arxiv.org/abs/2011.11874">https://arxiv.org/abs/2011.11874</a>.
</div>
<div id="ref-robinsMarginalStructuralModels2000" class="csl-entry">
Robins, James M., Miguel Ángel Hernán, and Babette Brumback. 2000.
<span>“Marginal Structural Models and Causal Inference in
Epidemiology.”</span> <em>Epidemiology</em> 11 (5): 550–60. <a href="https://doi.org/10.1097/00001648-200009000-00011">https://doi.org/10.1097/00001648-200009000-00011</a>.
</div>
<div id="ref-thoemmesPrimerInverseProbability2016" class="csl-entry">
Thoemmes, Felix J., and Anthony D. Ong. 2016. <span>“A Primer on Inverse
Probability of Treatment Weighting and Marginal Structural
Models.”</span> <em>Emerging Adulthood</em> 4 (1): 40–59. <a href="https://doi.org/10.1177/2167696815621645">https://doi.org/10.1177/2167696815621645</a>.
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
